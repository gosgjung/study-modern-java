# 97. 젊은 객체, 늙은 객체, 그리고 가비지

자바는 메모리를 두 영역으로 나눈다.

- 힙(heap) : 인스턴스, 변수
- 논 힙(Nonheap/perm) : 코드, 메타데이터

<br>

## 힙

자바에서 메모리를 관리하는 것은 힙에 주목해야 한다. 힙은 객체의 수명(lifetime)에 따라 아래의 두 영역으로 나뉜다.

- 영 제너레이션 (young generation)
  - 생명 주기가 짧은 객체를 보관한다.
- 올드 제너레이션 (old generation)
  - 생명 주기가 긴 구조체를 보관한다.

<br>

## 영 제너레이션 (young generation)

영 제너레이션은 다시 2개의 영역으로 나뉜다.

- 에덴(Eden)
  - 갓 생성된 오브젝트들이 위치하는 곳
- 서바이버(Survivor)
  - 영 제너레이션에서 올드 제너레이션을 이동하기 전, 거쳐가는 중간 상태

<br>

## 가비지 컬렉터

메모리를 깨끗하게 청소하는 시스템.<br>

아래의 작업들을 수행한다.<br>

- 마이너 컬렉션(minor collection)
  - 영 제너레이션 영역을 정리한다.
- 메이저 컬렉션(major collection)
  - 모든 영역(영, 올드 제너레이션)의 메모리를 정리한다.

<br>

GC는 일반 애플리케이션의 실행 중에 함께 실행된다. GC를 실행할 때마다 현재 동작하는 모든 스레드가 정지된다.<br>

만약 애플리케이션이 정상적으로 수행중일 경우 GC는 보통 애플리케이션의 실행을 방해하지 않기 위해 마이너 컬렉션만 수행한다.<br>

<br>

## GC 전략

애플리케이션이 효율적으로 동작하면서, 메모리가 효율적으로 관리되게끔 하려면 객체를 장시간 사용하지 말고 일시적으로 사용해야 한다.<br>

수명 주기가 짧은 객체는 에덴(Eden)에 저장되고, GC는 이런 객체를 더 일찍, 더 빠르게 정리한다.<br>

<br>

**사용하지 않는 객체가 메모리에 존재하면?**<br>

사용하지 않는 객체가 메모리에 오랫동안 존재하게 되는 경우가 있다. 이렇게 되면 애플리케이션이 중단되는 것은 아니지만, 하드웨어 성능에는 미세하게 영향을 준다. GC가 실행될 때마다 사용하지 않는 객체를 정리하는 작업이 반복되기에 GC의 성능이 떨어지게 될 가능성이 있다.<br>

<br>

**GC를 강제 실행하게 되면?**<br>

System.gc 를 직접 호출해 GC를 강제 실행하려고 하고자 할 수도 있다. 이럴 경우 메이저 컬렉션을 실행하게 되는데, GC가 알아서 필요한 때에 컬렉션을 실행하는 방식에 방해가 되기도 하고, GC가 동작하는 시간 동안 애플리케이션이 중단되게 된다.<br>

<br>

## 참조

GC는 더는 참조하지 않는 인스턴스를 정리한다.<br>

만약 하나의 인스턴스가 다른 인스턴스를 참조하는 애트리뷰트(attribute)를 가졌다면, 이 두 인스턴스는 같은 시점에 삭제되지 않는다. 이렇게 상호 참조하는 인스턴수가 많을 수록 GC 작업은 복잡해지고 오류가 발생하기 쉽다. 이런 경우는 객체의 애트리뷰트가 아무것도 참조하지 않도록 설정하면 인스턴스간 연결을 끊기에 GC 실행에 도움이 된다.<br>

<br>

## 정적 객체(`static object`)

정적 객체(`static object`)는 애플리케이션이 실행중인 동안에 유지된다. 정적 객체를 참조하는 애트리뷰트 역시 정적 객체가 유지되고 있으므로 계속 유지되게 된다.<br>

<br>

## java.leng.ref

`java.lang.ref` 패키지에는 GC 가 불필요한 객체를 정리할 수 있도록 돕기 위한 특별한 참조타입이 선언되어있다.<br>

- 약 참조 (weak reference)
  - 약 참조는 메모리 청소를 위한 참조로 간주되지 않는다.
  - ex) WeakHashMap ([http://oreil.ly/6PGRj](http://oreil.ly/6PGRj))
    - HashMap 과 동일한 동작을 가지지만, 약 참조를 가지는 Map 이다.
    - 맵 안에 맵에서만 참조되는 객체가 보관되어 있다면 이 객체는 GC에 의해 제거된다.
- 소프트 참조 (soft reference)
  - GC가 메모리 수요에 따라 인스턴스간 연결을 고려해 객체를 제거한다.
- 유령 참조 (phantom reference)
  - 항상 `null` 을 반환하며, 링크가 실제 객체를 가리키지 않는다.
  - 참조에 바인딩된 객체를 가져오기 전에 해당 인스턴스를 제거하기 위해 사용한다.



